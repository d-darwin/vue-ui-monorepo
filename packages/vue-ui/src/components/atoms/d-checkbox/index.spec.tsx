import { shallowMount } from "@vue/test-utils";
import DCheckbox from "@/components/atoms/d-checkbox";
import { BASE_COLOR_SCHEME } from "@/components/atoms/d-checkbox/constants";
import { SIZE } from "@darwin-studio/vue-ui-codegen/dist/constants/size";
import config from "@/components/atoms/d-checkbox/config";
import {
  baseClassCase,
  borderClassCase,
  colorSchemeClassCase,
  controlIdAbsenceCase,
  controlIdAutogeneratedCase,
  controlIdPresenceCase,
  errorClassCase,
  errorFontCase,
  errorHtmlCase,
  errorSlotCase,
  errorStringCase,
  inputAttrsCase,
  inputClassCase,
  inputValueCase,
  labelClassCase,
  labelFontCase,
  labelHtmlCase,
  labelPresenceCase,
  labelSlotCase,
  minControlWidthCase,
  outlineClassCase,
  paddingClassesCase,
  roundingClassCase,
  sizeClassCase,
  tagCase,
  transitionClassCase,
} from "@/utils/test-case-factories";
import colorSchemeStyles from "@darwin-studio/vue-ui-codegen/dist/styles/color-scheme.css"; // TODO: shorter path, default export ??? TODO: make it module ???
import styles from "./index.module.css";
import { COLOR_SCHEME } from "@darwin-studio/vue-ui-codegen/dist/constants/color-scheme";

describe("DCheckbox", () => {
  const wrapper = shallowMount(DCheckbox);

  baseClassCase(wrapper, config.className);

  it("Should render input element with checkbox type", () => {
    const inputEl = wrapper.find("input");
    expect(inputEl.exists()).toBeTruthy();
    expect(inputEl.attributes().type).toBe("checkbox");
  });

  inputValueCase(wrapper);

  inputClassCase(wrapper);

  inputAttrsCase(wrapper);

  minControlWidthCase(wrapper);

  it(`Should render default icon width ${config.checkMark}`, () => {
    wrapper.find(`.${config.iconClassName}`);
    expect(wrapper.exists()).toBeTruthy();
    expect(wrapper.text()).toBe(config.checkMark);
  });

  // TODO: make check slot factory
  it("Should render icon slot instead of default icon", () => {
    const slotIconClass = "slotAfter";
    const slotIcon = `<div class=${slotIconClass}>icon slot content</div>`;
    const wrapper = shallowMount(DCheckbox, {
      slots: {
        icon: slotIcon,
      },
    });
    const iconContainerEl = wrapper.find(`.${config.iconContainerClassName}`);
    expect(iconContainerEl.exists()).toBeTruthy();
    const slotIconEl = wrapper.find(`.${slotIconClass}`);
    expect(slotIconEl.exists()).toBeTruthy();
  });

  // TODO: make check target class ??
  it("Icon container classes should contain props.iconContainerClass if passed", async () => {
    const iconContainerClass = "iconContainerCustomClass";
    await wrapper.setProps({ iconContainerClass });
    const iconContainerEl = wrapper.find(`.${config.iconContainerClassName}`);
    expect(iconContainerEl.classes()).toContain(iconContainerClass);
  });

  it("Icon container classes should contain colorSchemeStyles.__disabled if props.disabled passed", async () => {
    await wrapper.setProps({ disabled: true });
    const iconContainerEl = wrapper.find(`.${config.iconContainerClassName}`);
    expect(iconContainerEl.classes()).toContain(colorSchemeStyles.__disabled);
  });

  labelPresenceCase(wrapper, `.${config.labelInnerClassName}`);

  labelClassCase(wrapper);

  labelFontCase(wrapper);

  labelHtmlCase(wrapper);

  labelSlotCase(DCheckbox);

  it("Label classes should contain __disabled if props.disabled passed", async () => {
    await wrapper.setProps({ disabled: true });
    const labelEl = wrapper.find("label");
    expect(labelEl.classes()).toContain(styles.__disabled);
  });

  controlIdPresenceCase(wrapper);

  controlIdAbsenceCase(wrapper);

  controlIdAutogeneratedCase(wrapper);

  borderClassCase(
    wrapper,
    wrapper.find(`.${config.iconContainerClassName}`),
    COLOR_SCHEME.SECONDARY
  );

  colorSchemeClassCase(
    wrapper,
    wrapper.find(`.${config.iconContainerClassName}`),
    COLOR_SCHEME.DANGER
  );

  outlineClassCase(
    wrapper,
    wrapper.find("input"),
    BASE_COLOR_SCHEME,
    SIZE.LARGE
  );

  paddingClassesCase(
    wrapper,
    wrapper.find(`.${config.iconContainerClassName}`)
  );

  roundingClassCase(wrapper, wrapper.find(`.${config.iconContainerClassName}`));

  sizeClassCase(wrapper, wrapper.find("input"));

  sizeClassCase(wrapper, wrapper.find(`.${config.iconContainerClassName}`));

  sizeClassCase(
    wrapper,
    wrapper.find(`.${config.iconContainerBackdropClassName}`)
  );

  transitionClassCase(
    wrapper,
    wrapper.find(`.${config.iconContainerClassName}`)
  );

  errorStringCase(wrapper, config.errorClassName);

  errorClassCase(wrapper, config.errorClassName);

  errorFontCase(wrapper, config.errorClassName);

  errorHtmlCase(wrapper, config.errorClassName);

  errorSlotCase(DCheckbox, config.errorClassName);

  it("Should emit onChange event with checked and value payload", async () => {
    const value = "some value";
    const checked = true;
    const wrapper = shallowMount(DCheckbox, { props: { value, checked } });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("change");

    expect(wrapper.emitted("change")?.[0]).toStrictEqual([
      !checked,
      !checked ? value : undefined,
    ]);
    expect(wrapper.emitted("update:checked")?.[0]).toStrictEqual([!checked]);
    expect(wrapper.emitted("update:value")?.[0]).toStrictEqual([
      !checked ? value : undefined,
    ]);
  });

  it("Shouldn't emit onChange it props.disabled is passed", async () => {
    const value = "some value";
    const checked = true;
    const disabled = true;
    const wrapper = shallowMount(DCheckbox, {
      props: { value, checked, disabled },
    });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("change");

    expect(wrapper.emitted("change")?.[0]).toBeFalsy();
    expect(wrapper.emitted("update:checked")?.[0]).toBeFalsy();
    expect(wrapper.emitted("update:value")?.[0]).toBeFalsy();
  });

  it("Should call passed props.whenChange", async () => {
    const value = "some value";
    const checked = true;
    const whenChange = jest.fn();
    const wrapper = shallowMount(DCheckbox, {
      props: { value, checked, whenChange },
    });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("change");

    expect(whenChange).toHaveBeenCalledWith(
      !checked,
      !checked ? value : undefined
    );
  });

  it("Shouldn't call passed props.whenChange if props.disabled passed", async () => {
    const value = "some value";
    const checked = true;
    const disabled = true;
    const whenChange = jest.fn();
    const wrapper = shallowMount(DCheckbox, {
      props: { value, checked, disabled, whenChange },
    });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("change");

    expect(whenChange).toHaveBeenCalledTimes(0);
  });

  it("Should emit onInput event with value payload", async () => {
    const value = "some value";
    const checked = true;
    const wrapper = shallowMount(DCheckbox, { props: { value, checked } });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("input");

    expect(wrapper.emitted("input")?.[0]).toStrictEqual([
      !checked ? value : undefined,
    ]);
    expect(wrapper.emitted("update:value")?.[0]).toStrictEqual([
      !checked ? value : undefined,
    ]);
  });

  it("Shouldn't emit onInput it props.disabled is passed", async () => {
    const value = "some value";
    const checked = true;
    const disabled = true;
    const wrapper = shallowMount(DCheckbox, {
      props: { value, checked, disabled },
    });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("input");

    expect(wrapper.emitted("input")?.[0]).toBeFalsy();
    expect(wrapper.emitted("update:value")?.[0]).toBeFalsy();
  });

  it("Should call passed props.whenInput", async () => {
    const value = "some value";
    const checked = true;
    const whenInput = jest.fn();
    const wrapper = shallowMount(DCheckbox, {
      props: { value, checked, whenInput },
    });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("input");

    expect(whenInput).toHaveBeenCalledWith(!checked ? value : undefined);
  });

  it("Shouldn't call passed props.whenInput if props.disabled passed", async () => {
    const value = "some value";
    const checked = true;
    const disabled = true;
    const whenInput = jest.fn();
    const wrapper = shallowMount(DCheckbox, {
      props: { value, checked, disabled, whenInput },
    });
    const inputEl = wrapper.find("input");
    await inputEl.trigger("click");
    await inputEl.trigger("input");

    expect(whenInput).toHaveBeenCalledTimes(0);
  });

  tagCase(wrapper);
});
